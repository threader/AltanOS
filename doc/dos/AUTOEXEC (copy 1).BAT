@ECHO OFF

SET CC=US
SET DRV=X:
SET COPYR=
SET drive=A


DSKSTATE
IF ERRORLEVEL 3 GOTO DSTATE3
IF ERRORLEVEL 2 GOTO DSTATE2
IF ERRORLEVEL 1 GOTO DSTATE1
IF ERRORLEVEL 0 GOTO DSTATE0

:DSTATE3
SET DSTATE=3
GOTO GETDRV

:DSTATE2
SET DSTATE=2
GOTO GETDRV

:DSTATE1
SET DSTATE=1
GOTO GETDRV

:DSTATE0
SET DSTATE=0


:GETDRV
getdrive.exe /CC=%CC%
IF ERRORLEVEL 1003 GOTO PANASONIC
IF ERRORLEVEL 1002 GOTO USBCD
IF ERRORLEVEL 1001 GOTO DOCK
IF ERRORLEVEL 1000 GOTO INTERNAL
IF ERRORLEVEL 0 GOTO NOSELECT

:PDB2K
LH MSCDEX /D:IBMCD001 /V /L:X
GOTO NOWGO

:PANASONIC
rem Panasonic USB Drive
DYNALOAD RAMFD.SYS
DYNALOAD USBASPI.SYS
DYNALOAD USBCD.SYS /D:USBCD001
LH MSCDEX.EXE /D:USBCD001 /M:10 /L:X
GOTO NOWGO

:USBCD
CALL SETUPRMD.BAT
DYNALOAD USB_CD.SYS /D:USBCD001
LH MSCDEX.EXE /D:USBCD001 /L:X
GOTO NOWUSB

:DOCK
LH A:\MSCDEX.EXE /D:CMD_CD /L:X
GOTO NOWGO

:INTERNAL
LH A:\MSCDEX /D:IBMCD001 /V /L:X /M:8
GOTO NOWGO

:NOSELECT
ECHO NO CD DRIVE SELECTION WAS MADE.
GOTO DONE

:NOWGO

A:\SMARTDRV.EXE 2048 C+ /U

CALL FINDDRV.BAT
COPY A:\*.* %RAMD%\ > NUL
SET COMSPEC=%RAMD%\COMMAND.COM

ECHO .
ECHO -----------------
ECHO Recovery Drive=%DRV%
ECHO RAM Drive     =%RAMD%
ECHO -----------------
ECHO .
%RAMD%
                                        
PATH=%RAMD%\;%DRV%\RECOVERY
SUBST A: %RAMD%\

:NOWUSB

call %drive%:\DISKETTE.EXE B >NUL
if errorlevel 1 goto YESdiskette
GOTO START

:YESdiskette
if exist B:\MFGMODE goto MFGmode
if exist B:\ERROR.LOG goto MFGcleanup
GOTO START

:MFGmode
if exist B:\PREDL.bat call B:\PREDL.bat
%DRV%\recovery\recover.exe /AUTO /P:%DRV%\RECOVERY
if exist B:\VEPT.EXE B:\VEPT.EXE /n /c /ww
if exist B:\DEVMODE goto DONE
call a:\veptcrc.bat
if exist B:\ERROR.LOG goto DLerror
if exist B:\POSTDL.bat call B:\POSTDL.bat
%drive%:\set_cmos 0 0x36 xxxx0000
%drive%:\set_cmos 0 0x36 0010xxxx

if exist c:\windows\options\oemaudit.inf goto 9XAUDIT
%drive%:\fmodify.exe %drive%:\auditnt.fm
GOTO LASTOFAUDIT
:9XAUDIT
%drive%:\fmodify.exe %drive%:\audit98.fm
rem c:\windows\regedit /L:C:\WINDOWS\system.dat /R:C:\WINDOWS\user.dat %drive%:\mfgbooti.reg
copy %drive%:\mfgbooti.reg c:\mfgboot.reg /y
copy %drive%:\unaudit.exe c:\
copy %drive%:\MFGRESET.BAT c:\
copy %drive%:\set_cmos.exe c:\

:LASTOFAUDIT
copy %drive%:\set_boot.exe c:\
%drive%:\setbootb.exe /RH
copy %drive%:\ERROR.LOG B:\
%drive%:\REBOOT.EXE
GOTO DONE

:MFGcleanup
if exist B:\POSTAUD.bat call B:\POSTAUD.bat
copy A:\TESTER.CTL B:\
del c:\set_cmos.exe
del c:\unaudit.exe
del c:\MFGRESET.BAT
del c:\SET_BOOT.EXE
del b:\error.log
A:\set_cmos 0 0x36 xxxx0000
A:\REBOOT.EXE
GOTO DONE

:DLerror
copy A:\TESTER.CTL B:\
A:\set_cmos 0 0x36 xxxx0000
A:\REBOOT.EXE
GOTO DONE

:START
CLS
IF %DSTATE%==2 GOTO GORECOV            
IF %DSTATE%==1 GOTO DORECOV            
IF %DSTATE%==0 GOTO CONTINUE           

:DORECOV
IF EXIST C:\$APTINST.DAT GOTO DELFILE

:GORECOV
%DRV%\RECOVERY\RECOVER.EXE %COPYR% /P:%DRV%\RECOVERY
IF ERRORLEVEL 2527 GOTO DIAGDISK
IF ERRORLEVEL 2525 GOTO DIAGNOSTICS
IF ERRORLEVEL 2523 GOTO SYSTEMINFO
GOTO DONE

:DELFILE
ERASE C:\$APTINST.DAT

:CONTINUE
%DRV%\RECOVERY\RECOVER.EXE /Y %COPYR% /P:%DRV%\RECOVERY
IF ERRORLEVEL 2527 GOTO DIAGDISK
IF ERRORLEVEL 2525 GOTO DIAGNOSTICS
IF ERRORLEVEL 2523 GOTO SYSTEMINFO
GOTO DONE

:SYSTEMINFO
SET COPYR=/S
%DRV%
CD \PCDR
A:\EMM386.EXE OFF
%DRV%\PCDR\PCDR.EXE /SI /PAUSE
A:\EMM386.EXE ON
CD \
GOTO START

:DIAGNOSTICS
SET COPYR=/S
%DRV%
CD \PCDR
A:\EMM386.EXE OFF
%DRV%\PCDR\PCDR.EXE
A:\EMM386.EXE ON
CD \
GOTO START

:DIAGDISK
SET COPYR=/S
%DRV%\PCDR\MAKEDIAG.EXE B:
PAUSE
GOTO START

:DONE
@ECHO ON
